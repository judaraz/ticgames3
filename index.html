<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CashReward Admin Panel - Game Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .admin-page { display: none; }
        .admin-page.active { display: block; animation: fadeIn 0.5s; }
        .sidebar-link { transition: all 0.2s; border-left: 3px solid transparent; }
        .sidebar-link.active, .sidebar-link:hover { background-color: #4f46e5; color: white; border-left-color: #818cf8; }
        .stat-card { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); }
        .input-field { border: 1px solid #cbd5e1; padding: 0.5rem 0.75rem; border-radius: 0.375rem; width: 100%; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s; cursor: pointer; }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background-color: #4f46e5; color: white; border: none; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #64748b; color: white; border: none; }
        .btn-danger { background-color: #ef4444; color: white; border: none; }
        .btn-success { background-color: #10b981; color: white; border: none; }
        .btn-warning { background-color: #f59e0b; color: white; border: none; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        #toast-notification { transition: opacity 0.5s ease-in-out; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background-color: #f9fafb; font-weight: 600; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .status-active { background-color: #d1fae5; color: #065f46; }
        .status-blocked { background-color: #fee2e2; color: #991b1b; }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-approved { background-color: #d1fae5; color: #065f46; }
        .status-rejected { background-color: #fee2e2; color: #991b1b; }
        .status-visible { background-color: #3b82f6; color: white; }
        .status-hidden { background-color: #6b7280; color: white; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal { background: white; border-radius: 0.5rem; max-width: 500px; margin: 2rem auto; padding: 1.5rem; max-height: 80vh; overflow-y: auto; }
        .point-input { width: 100px; text-align: center; }
        .view-points-btn { background-color: #3b82f6; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; }
        .game-card { background: white; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1); }
        .time-input { width: 120px; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
        .website-item { display: flex; gap: 10px; margin-bottom: 10px; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb; }
        .website-field { flex: 1; }
        .website-field input { width: 100%; }
    </style>
</head>
<body>
    <!-- Loader -->
    <div id="loader" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
    </div>
    
    <!-- Login Section -->
    <div id="auth-section" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Admin Panel Login</h2>
            <input id="login-email" type="email" placeholder="Email" class="input-field mb-4">
            <input id="login-password" type="password" placeholder="Password" class="input-field mb-4">
            <button id="login-btn" class="btn btn-primary w-full">Login</button>
            <p id="login-error" class="text-red-500 text-sm mt-2 text-center"></p>
        </div>
    </div>

    <!-- Main Admin Panel -->
    <div id="panel-section" class="hidden">
        <div class="flex h-screen bg-gray-100">
            <!-- Sidebar -->
            <aside class="w-64 bg-gray-800 text-gray-200 flex-shrink-0">
                <div class="p-4 text-2xl font-bold text-white">CashReward</div>
                <nav class="mt-6">
                    <a href="#" data-page="dashboard" class="sidebar-link active flex items-center py-3 px-4">
                        <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>Dashboard
                    </a>
                    <a href="#" data-page="users" class="sidebar-link flex items-center py-3 px-4">
                        <i data-lucide="users" class="w-5 h-5 mr-3"></i>Users
                    </a>
                    <a href="#" data-page="withdrawals" class="sidebar-link flex items-center py-3 px-4">
                        <i data-lucide="banknote" class="w-5 h-5 mr-3"></i>Withdrawals
                    </a>
                    <a href="#" data-page="games" class="sidebar-link flex items-center py-3 px-4">
                        <i data-lucide="gamepad-2" class="w-5 h-5 mr-3"></i>Game Management
                    </a>
                    <a href="#" data-page="notifications" class="sidebar-link flex items-center py-3 px-4">
                        <i data-lucide="send" class="w-5 h-5 mr-3"></i>Notifications
                    </a>
                    <a href="#" data-page="settings" class="sidebar-link flex items-center py-3 px-4">
                        <i data-lucide="settings" class="w-5 h-5 mr-3"></i>App Settings
                    </a>
                </nav>
                <div class="absolute bottom-0 w-64 p-4">
                    <button id="logout-btn" class="w-full bg-red-600 text-white py-2 rounded-lg">Logout</button>
                </div>
            </aside>
            
            <!-- Main Content -->
            <main class="flex-1 p-6 overflow-y-auto">
                <div id="dashboard" class="admin-page active"></div>
                <div id="users" class="admin-page"></div>
                <div id="withdrawals" class="admin-page"></div>
                <div id="games" class="admin-page"></div>
                <div id="notifications" class="admin-page"></div>
                <div id="settings" class="admin-page"></div>
            </main>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="hidden fixed top-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 z-50">
        <p id="toast-message"></p>
    </div>

    <!-- Alert Modal -->
    <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm text-center shadow-xl">
            <p id="alert-message" class="mb-4 text-gray-800"></p>
            <button id="alert-ok-btn" class="btn btn-primary px-6">OK</button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="custom-confirm" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm text-center shadow-xl">
            <p id="confirm-message" class="mb-6 text-gray-800"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="btn bg-gray-200 text-gray-800 px-6">Cancel</button>
                <button id="confirm-ok-btn" class="btn btn-danger px-6">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Edit User Points Modal -->
    <div id="edit-points-modal" class="modal-overlay">
        <div class="modal">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Edit User Points</h3>
                <button onclick="closeEditPointsModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-gray-600">User: <span id="edit-user-name" class="font-semibold"></span></p>
                <p class="text-gray-600">Email: <span id="edit-user-email" class="font-semibold"></span></p>
                <p class="text-gray-600">Current Balance: <span id="edit-current-balance" class="font-semibold"></span></p>
            </div>
            <div class="mb-6">
                <label class="block font-semibold mb-2">New Balance</label>
                <input type="number" id="new-balance-input" class="input-field" placeholder="Enter new balance">
            </div>
            <div class="flex justify-end space-x-2">
                <button onclick="closeEditPointsModal()" class="btn bg-gray-200 text-gray-800">Cancel</button>
                <button onclick="saveUserPoints()" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- User Point History Modal -->
    <div id="user-point-history-modal" class="modal-overlay">
        <div class="modal" style="max-width: 800px;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Point History - <span id="history-user-name"></span></h3>
                <button onclick="closePointHistoryModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-gray-600">User ID: <span id="history-user-id" class="font-semibold"></span></p>
                <p class="text-gray-600">Total Points Earned: <span id="total-points-earned" class="font-semibold text-green-600"></span></p>
            </div>
            <div class="overflow-y-auto max-h-96">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-2">Date & Time</th>
                            <th class="px-4 py-2">Task</th>
                            <th class="px-4 py-2">Points</th>
                            <th class="px-4 py-2">Country</th>
                            <th class="px-4 py-2">Details</th>
                        </tr>
                    </thead>
                    <tbody id="user-point-history-body">
                        <!-- Point history will be loaded here -->
                    </tbody>
                </table>
            </div>
            <div class="mt-4 flex justify-end">
                <button onclick="closePointHistoryModal()" class="btn bg-gray-200 text-gray-800">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Game Modal -->
    <div id="edit-game-modal" class="modal-overlay">
        <div class="modal" style="max-width: 600px;">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Edit Game Settings</h3>
                <button onclick="closeEditGameModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <div>
                    <h4 class="font-semibold text-lg mb-2" id="edit-game-title">Color Game</h4>
                    <p class="text-gray-600 text-sm" id="edit-game-description">Configure game settings and rewards</p>
                </div>
                
                <div>
                    <label class="block font-semibold mb-2">Daily Time Limit (minutes)</label>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="edit-game-time-limit" class="input-field time-input" min="0" max="1440" placeholder="e.g., 60">
                        <span class="text-gray-600">minutes per day</span>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">0 = unlimited play time</p>
                </div>
                
                <div>
                    <label class="block font-semibold mb-2">Session Time Limit (minutes)</label>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="edit-game-session-limit" class="input-field time-input" min="0" max="240" placeholder="e.g., 10">
                        <span class="text-gray-600">minutes per session</span>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">Maximum continuous play time before break</p>
                </div>
                
                <div>
                    <label class="block font-semibold mb-2">Cooldown Period (minutes)</label>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="edit-game-cooldown" class="input-field time-input" min="0" max="480" placeholder="e.g., 30">
                        <span class="text-gray-600">minutes between sessions</span>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">Wait time after reaching session limit</p>
                </div>
                
                <div>
                    <label class="block font-semibold mb-2">Reward Per Play (points)</label>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="edit-game-reward-per-play" class="input-field time-input" min="0" placeholder="e.g., 10">
                        <span class="text-gray-600">points per successful play</span>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">Points earned for completing this game</p>
                </div>
                
                <div>
                    <label class="block font-semibold mb-2">Daily Play Limit</label>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="edit-game-daily-limit" class="input-field time-input" min="0" placeholder="e.g., 20">
                        <span class="text-gray-600">plays per day</span>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">Maximum number of plays per day (0 = unlimited)</p>
                </div>
                
                <div class="flex items-center justify-between">
                    <div>
                        <label class="font-semibold">Game Visibility</label>
                        <p class="text-sm text-gray-500">Show/hide this game in the mini-app</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="edit-game-visible">
                        <span class="slider round"></span>
                    </label>
                </div>
                
                <div>
                    <label class="block font-semibold mb-2">Game Order</label>
                    <input type="number" id="edit-game-order" class="input-field w-32" min="1" max="10" placeholder="1-10">
                    <p class="text-sm text-gray-500 mt-1">Display order in mini-app (1 = first)</p>
                </div>
            </div>
            
            <div class="mt-8 flex justify-end space-x-3">
                <button onclick="closeEditGameModal()" class="btn bg-gray-200 text-gray-800 px-6">Cancel</button>
                <button onclick="saveGameSettings()" class="btn btn-primary px-6">Save Settings</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCSX_YNQ9aIgWFFGZWYQXWwClTEjym7w_U",
            authDomain: "cash-8a849.firebaseapp.com",
            projectId: "cash-8a849",
            storageBucket: "cash-8a849.firebasestorage.app",
            messagingSenderId: "593492117301",
            appId: "1:593492117301:web:edbf5807f65380b9d4ae7c"
        };
        
        const ADMIN_UIDS = ["R9FgFY4URDQRX0VRMRnURgSLDzi2"];

        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            updateDoc, 
            collection, 
            getDocs, 
            writeBatch, 
            enableIndexedDbPersistence, 
            query, 
            where, 
            onSnapshot, 
            addDoc, 
            serverTimestamp, 
            setDoc,
            orderBy,
            limit,
            deleteDoc,
            arrayUnion,
            arrayRemove
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Enable persistence
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                console.warn('Firestore persistence failed: multiple tabs open.');
            } else if (err.code == 'unimplemented') {
                console.warn('Firestore persistence not available in this browser.');
            }
        });

        // DOM Elements
        const loader = document.getElementById('loader');
        let currentEditingUserId = null;
        let currentViewingUserId = null;
        let currentEditingGameId = null;

        // Initialize on load
        window.onload = () => {
            lucide.createIcons();
            setupEventListeners();
            onAuthStateChanged(auth, handleAuthStateChange);
        };

        // Auth State Handler
        function handleAuthStateChange(user) {
            if (user && ADMIN_UIDS.includes(user.uid)) {
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('panel-section').style.display = 'block';
                navigateTo('dashboard');
                loadDashboardData();
                loadUsers();
                loadWithdrawals();
                loadSettings();
            } else {
                document.getElementById('auth-section').style.display = 'flex';
                document.getElementById('panel-section').style.display = 'none';
                if (user) {
                    signOut(auth);
                    showAlert("You are not authorized to access this panel.");
                }
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            
            // Navigation
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateTo(link.dataset.page);
                });
            });
            
            // Alert/Confirm buttons
            document.getElementById('alert-ok-btn').addEventListener('click', () => {
                document.getElementById('custom-alert').classList.add('hidden');
            });
            
            document.getElementById('confirm-cancel-btn').addEventListener('click', () => {
                document.getElementById('custom-confirm').classList.add('hidden');
            });
        }

        // Login Handler
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = '';
            loader.style.display = 'flex';
            
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                if (!ADMIN_UIDS.includes(userCredential.user.uid)) {
                    await signOut(auth);
                    showAlert("You are not authorized to access this panel.");
                }
            } catch (error) {
                errorEl.textContent = "Invalid email or password.";
                console.error("Login error:", error);
            } finally {
                loader.style.display = 'none';
            }
        }

        // Navigation
        function navigateTo(pageId) {
            document.querySelectorAll('.admin-page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`.sidebar-link[data-page="${pageId}"]`).classList.add('active');

            if (pageId === 'dashboard') loadDashboard();
            if (pageId === 'users') loadUsers();
            if (pageId === 'withdrawals') loadWithdrawals();
            if (pageId === 'games') loadGames();
            if (pageId === 'notifications') loadNotifications();
            if (pageId === 'settings') loadSettings();
        }

        // Dashboard Functions
        async function loadDashboard() {
            const page = document.getElementById('dashboard');
            page.innerHTML = `
                <h1 class="text-3xl font-bold mb-6">Dashboard</h1>
                <div id="stats-grid" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="stat-card p-6"><h3 class="text-gray-500 text-lg">Total Users</h3><p id="total-users" class="text-4xl font-bold mt-2">0</p></div>
                    <div class="stat-card p-6"><h3 class="text-gray-500 text-lg">Total Withdrawals</h3><p id="total-withdrawals" class="text-4xl font-bold mt-2">0</p></div>
                    <div class="stat-card p-6"><h3 class="text-gray-500 text-lg">Pending Withdrawals</h3><p id="pending-withdrawals" class="text-4xl font-bold text-orange-500 mt-2">0</p></div>
                    <div class="stat-card p-6"><h3 class="text-gray-500 text-lg">Today's Earnings</h3><p id="today-earnings" class="text-4xl font-bold text-green-600 mt-2">0</p></div>
                </div>
                <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h2 class="text-2xl font-bold mb-4">Recent Withdrawals</h2>
                        <div id="recent-withdrawals" class="bg-white shadow rounded-lg p-4">
                            Loading...
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-4">Recent Users</h2>
                        <div id="recent-users" class="bg-white shadow rounded-lg p-4">
                            Loading...
                        </div>
                    </div>
                </div>
                <div class="mt-8">
                    <h2 class="text-2xl font-bold mb-4">Game Statistics</h2>
                    <div id="game-stats" class="bg-white shadow rounded-lg p-4">
                        Loading...
                    </div>
                </div>
            `;
            
            // Load real-time data
            loadDashboardData();
        }

        function loadDashboardData() {
            // Total Users (real-time)
            onSnapshot(collection(db, "users"), snap => {
                document.getElementById('total-users').textContent = snap.size;
            });

            // Total Withdrawals (real-time)
            onSnapshot(collection(db, "withdrawals"), snap => {
                document.getElementById('total-withdrawals').textContent = snap.size;
            });

            // Pending Withdrawals (real-time)
            onSnapshot(query(collection(db, "withdrawals"), where("status", "==", "pending")), snap => {
                document.getElementById('pending-withdrawals').textContent = snap.size;
            });

            // Load recent data
            loadRecentWithdrawals();
            loadRecentUsers();
            loadTodayEarnings();
            loadGameStats();
        }

        async function loadRecentWithdrawals() {
            const withdrawalsSnap = await getDocs(query(
                collection(db, "withdrawals"), 
                orderBy("requestedAt", "desc"), 
                limit(5)
            ));
            
            let html = `<table class="w-full">
                <thead><tr><th>User</th><th>Amount</th><th>Status</th><th>Date</th></tr></thead>
                <tbody>`;
            
            if (withdrawalsSnap.empty) {
                html += `<tr><td colspan="4" class="text-center py-4 text-gray-500">No recent withdrawals</td></tr>`;
            } else {
                withdrawalsSnap.forEach(doc => {
                    const req = doc.data();
                    const date = req.requestedAt?.toDate().toLocaleDateString() || 'N/A';
                    const statusClass = req.status === 'approved' ? 'status-approved' : 
                                      req.status === 'pending' ? 'status-pending' : 'status-rejected';
                    html += `<tr class="border-b">
                        <td class="py-2">${req.userName || 'N/A'}</td>
                        <td class="py-2 font-semibold">${req.amount}</td>
                        <td class="py-2"><span class="status-badge ${statusClass}">${req.status}</span></td>
                        <td class="py-2 text-gray-500 text-sm">${date}</td>
                    </tr>`;
                });
            }
            
            html += `</tbody></table>`;
            document.getElementById('recent-withdrawals').innerHTML = html;
        }

        async function loadRecentUsers() {
            const usersSnap = await getDocs(query(
                collection(db, "users"), 
                orderBy("createdAt", "desc"), 
                limit(5)
            ));
            
            let html = `<table class="w-full">
                <thead><tr><th>Name</th><th>Email</th><th>Balance</th><th>Status</th></tr></thead>
                <tbody>`;
            
            if (usersSnap.empty) {
                html += `<tr><td colspan="4" class="text-center py-4 text-gray-500">No users found</td></tr>`;
            } else {
                usersSnap.forEach(doc => {
                    const user = doc.data();
                    const isBlocked = user.isBlocked || false;
                    const statusClass = isBlocked ? 'status-blocked' : 'status-active';
                    html += `<tr class="border-b">
                        <td class="py-2">${user.name || 'N/A'}</td>
                        <td class="py-2">${user.email || 'N/A'}</td>
                        <td class="py-2 font-semibold">${user.balance || 0}</td>
                        <td class="py-2"><span class="status-badge ${statusClass}">${isBlocked ? 'Blocked' : 'Active'}</span></td>
                    </tr>`;
                });
            }
            
            html += `</tbody></table>`;
            document.getElementById('recent-users').innerHTML = html;
        }

        async function loadTodayEarnings() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const pointHistorySnap = await getDocs(query(
                collection(db, "pointHistory"),
                where("timestamp", ">=", today)
            ));
            
            let totalEarnings = 0;
            pointHistorySnap.forEach(doc => {
                const history = doc.data();
                if (history.points > 0) {
                    totalEarnings += history.points;
                }
            });
            
            document.getElementById('today-earnings').textContent = totalEarnings;
        }

        async function loadGameStats() {
            try {
                // Get game configuration
                const gamesSnap = await getDoc(doc(db, "config", "games"));
                const gamesConfig = gamesSnap.exists() ? gamesSnap.data() : {};
                
                // Get today's game play data
                const today = new Date().toISOString().split('T')[0];
                const todayStats = gamesConfig.dailyStats?.[today] || {};
                
                let html = '<div class="grid grid-cols-1 md:grid-cols-3 gap-4">';
                
                // Games list
                const games = [
                    { id: 'colorGame', name: 'Color Game', icon: 'palette', color: 'bg-purple-500' },
                    { id: 'watchVideo', name: 'Watch Video', icon: 'video', color: 'bg-blue-500' },
                    { id: 'ludoDice', name: 'Ludo Dice', icon: 'dice-5', color: 'bg-green-500' }
                ];
                
                games.forEach(game => {
                    const gameData = gamesConfig[game.id] || {};
                    const gameStats = todayStats[game.id] || { playCount: 0, totalPlays: 0, userCount: 0 };
                    const isVisible = gameData.visible !== false;
                    const dailyLimit = gameData.dailyTimeLimit || 0;
                    
                    html += `
                        <div class="game-card">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center">
                                    <div class="${game.color} text-white p-2 rounded-lg mr-3">
                                        <i data-lucide="${game.icon}" class="w-5 h-5"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold">${game.name}</h3>
                                        <p class="text-sm text-gray-500">${isVisible ? 'Visible' : 'Hidden'}</p>
                                    </div>
                                </div>
                                <span class="status-badge ${isVisible ? 'status-visible' : 'status-hidden'}">
                                    ${isVisible ? 'Visible' : 'Hidden'}
                                </span>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3 mt-4">
                                <div>
                                    <p class="text-sm text-gray-500">Today's Plays</p>
                                    <p class="font-bold text-lg">${gameStats.playCount || 0}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Total Users</p>
                                    <p class="font-bold text-lg">${gameStats.userCount || 0}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Daily Limit</p>
                                    <p class="font-bold text-lg">${dailyLimit > 0 ? `${dailyLimit} min` : 'Unlimited'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Reward</p>
                                    <p class="font-bold text-lg">${gameData.rewardPerPlay || 0} pts</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                document.getElementById('game-stats').innerHTML = html;
                lucide.createIcons();
            } catch (error) {
                console.error("Error loading game stats:", error);
                document.getElementById('game-stats').innerHTML = 
                    `<p class="text-center text-gray-500">Error loading game statistics</p>`;
            }
        }

        // Users Functions
        async function loadUsers() {
            const page = document.getElementById('users');
            page.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold">User Management</h1>
                    <div class="flex space-x-2">
                        <input type="text" id="user-search" placeholder="Search users..." class="input-field w-64">
                        <button onclick="searchUsers()" class="btn btn-primary">Search</button>
                    </div>
                </div>
                <div class="bg-white shadow rounded-lg p-4">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3">Name</th>
                                    <th class="px-6 py-3">Email</th>
                                    <th class="px-6 py-3">Balance</th>
                                    <th class="px-6 py-3">Country</th>
                                    <th class="px-6 py-3">Daily Ads</th>
                                    <th class="px-6 py-3">Status</th>
                                    <th class="px-6 py-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">Loading...</tbody>
                        </table>
                    </div>
                </div>
            `;
            
            await loadUsersData();
            
            // Add search event listener
            document.getElementById('user-search').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') searchUsers();
            });
        }

        async function loadUsersData(searchTerm = '') {
            const configSnap = await getDoc(doc(db, "config", "main"));
            const config = configSnap.exists() ? configSnap.data() : {};
            const dailyAdLimit = config.dailyAdLimit || 100;
            
            const usersSnap = await getDocs(collection(db, "users"));
            let tableHTML = '';
            
            usersSnap.forEach(doc => {
                const user = doc.data();
                const userId = doc.id;
                const isBlocked = user.isBlocked || false;
                const userEmail = user.email || '';
                const userName = user.name || 'N/A';
                
                // Filter by search term
                if (searchTerm && 
                    !userName.toLowerCase().includes(searchTerm.toLowerCase()) && 
                    !userEmail.toLowerCase().includes(searchTerm.toLowerCase())) {
                    return;
                }
                
                const dailyAdsWatched = user.dailyAdCount || 0;
                const country = user.country || 'N/A';
                
                tableHTML += `<tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-6 py-4">${userName}</td>
                    <td class="px-6 py-4">${userEmail}</td>
                    <td class="px-6 py-4">
                        <div class="flex items-center space-x-2">
                            <span class="font-semibold">${user.balance || 0}</span>
                            <button onclick="openEditPointsModal('${userId}', '${userName}', '${userEmail}', ${user.balance || 0})" 
                                    class="btn btn-sm btn-warning">Edit</button>
                            <button onclick="viewUserPointHistory('${userId}', '${userName}')" 
                                    class="view-points-btn btn-sm">View Points</button>
                        </div>
                    </td>
                    <td class="px-6 py-4">${country}</td>
                    <td class="px-6 py-4">
                        <div class="flex items-center space-x-2">
                            <span class="font-semibold ${dailyAdsWatched >= dailyAdLimit ? 'text-red-600' : 'text-green-600'}">
                                ${dailyAdsWatched}/${dailyAdLimit}
                            </span>
                            ${dailyAdsWatched >= dailyAdLimit ? 
                                '<span class="text-xs text-red-500">Limit Reached</span>' : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="status-badge ${isBlocked ? 'status-blocked' : 'status-active'}">
                            ${isBlocked ? 'Blocked' : 'Active'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex space-x-2">
                            <button onclick="toggleUserBlock('${userId}', ${isBlocked})" 
                                    class="btn btn-sm ${isBlocked ? 'btn-success' : 'btn-danger'}">
                                ${isBlocked ? 'Unblock' : 'Block'}
                            </button>
                            <button onclick="resetDailyAds('${userId}')" 
                                    class="btn btn-sm btn-secondary">
                                Reset Ads
                            </button>
                        </div>
                    </td>
                </tr>`;
            });
            
            if (!tableHTML) {
                tableHTML = `<tr><td colspan="7" class="text-center py-4 text-gray-500">No users found</td></tr>`;
            }
            
            document.getElementById('users-table-body').innerHTML = tableHTML;
        }

        function searchUsers() {
            const searchTerm = document.getElementById('user-search').value;
            loadUsersData(searchTerm);
        }

        // Withdrawals Functions
        async function loadWithdrawals() {
            const page = document.getElementById('withdrawals');
            page.innerHTML = `
                <h1 class="text-3xl font-bold mb-6">Withdrawal Requests</h1>
                <div class="mb-4 flex space-x-4">
                    <button onclick="filterWithdrawals('all')" class="btn btn-primary">All</button>
                    <button onclick="filterWithdrawals('pending')" class="btn btn-warning">Pending</button>
                    <button onclick="filterWithdrawals('approved')" class="btn btn-success">Approved</button>
                    <button onclick="filterWithdrawals('rejected')" class="btn btn-danger">Rejected</button>
                </div>
                <div class="bg-white shadow rounded-lg p-4">
                    <div class="overflow-x-auto">
                        <div id="withdrawals-table-container">Loading...</div>
                    </div>
                </div>
            `;
            
            await loadWithdrawalsData('all');
        }

        async function loadWithdrawalsData(filter = 'all') {
            let q;
            if (filter === 'all') {
                q = query(collection(db, "withdrawals"), orderBy("requestedAt", "desc"));
            } else {
                q = query(collection(db, "withdrawals"), where("status", "==", filter), orderBy("requestedAt", "desc"));
            }
            
            const withdrawalsSnap = await getDocs(q);
            
            if (withdrawalsSnap.empty) {
                document.getElementById('withdrawals-table-container').innerHTML = 
                    `<p class="text-center p-4 text-gray-500">No withdrawal requests found.</p>`;
                return;
            }

            let tableHTML = `<table class="w-full text-sm text-left text-gray-600">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th class="px-6 py-3">User</th>
                        <th class="px-6 py-3">Amount</th>
                        <th class="px-6 py-3">Method</th>
                        <th class="px-6 py-3">Details</th>
                        <th class="px-6 py-3">Country</th>
                        <th class="px-6 py-3">Requested At</th>
                        <th class="px-6 py-3">Status</th>
                        <th class="px-6 py-3">Actions</th>
                    </tr>
                </thead>
                <tbody>`;
            
            withdrawalsSnap.forEach(doc => {
                const req = doc.data();
                const requestedDate = req.requestedAt?.toDate().toLocaleString() || 'N/A';
                const statusClass = req.status === 'approved' ? 'status-approved' : 
                                  req.status === 'pending' ? 'status-pending' : 'status-rejected';
                const country = req.country || 'N/A';
                
                tableHTML += `<tr class="bg-white border-b">
                    <td class="px-6 py-4">
                        <div class="flex items-center space-x-2">
                            <span>${req.userName || 'N/A'}</span>
                            <button onclick="viewUserPointHistory('${req.userId}', '${req.userName}')" 
                                    class="view-points-btn btn-sm">View Points</button>
                        </div>
                    </td>
                    <td class="px-6 py-4 font-semibold">${req.amount}</td>
                    <td class="px-6 py-4">${req.method}</td>
                    <td class="px-6 py-4 truncate max-w-xs" title="${req.paymentDetail}">${req.paymentDetail || 'N/A'}</td>
                    <td class="px-6 py-4">${country}</td>
                    <td class="px-6 py-4 text-gray-500 text-sm">${requestedDate}</td>
                    <td class="px-6 py-4"><span class="status-badge ${statusClass}">${req.status}</span></td>
                    <td class="px-6 py-4">
                        ${req.status === 'pending' ? `
                        <div class="flex space-x-2">
                            <button onclick="processWithdrawal('${doc.id}', 'approved')" class="btn-success text-xs px-2 py-1 rounded">Approve</button>
                            <button onclick="processWithdrawal('${doc.id}', 'rejected')" class="btn-danger text-xs px-2 py-1 rounded">Reject</button>
                        </div>
                        ` : 'â€”'}
                    </td>
                </tr>`;
            });
            
            tableHTML += `</tbody></table>`;
            document.getElementById('withdrawals-table-container').innerHTML = tableHTML;
        }

        function filterWithdrawals(status) {
            loadWithdrawalsData(status);
        }

        // ===== GAME MANAGEMENT =====
        async function loadGames() {
            const page = document.getElementById('games');
            page.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold">Game Management</h1>
                    <button onclick="resetAllGameStats()" class="btn btn-warning">
                        Reset All Game Stats
                    </button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Color Game Card -->
                    <div class="game-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <div class="bg-purple-500 text-white p-3 rounded-lg mr-3">
                                    <i data-lucide="palette" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <h2 class="text-xl font-bold">Color Game</h2>
                                    <p class="text-sm text-gray-500">Match colors to earn points</p>
                                </div>
                            </div>
                            <span id="colorGame-status" class="status-badge status-visible">Visible</span>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="font-semibold">Daily Time Limit:</span>
                                <span id="colorGame-time-limit" class="font-bold">60 minutes</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="font-semibold">Daily Play Limit:</span>
                                <span id="colorGame-daily-limit" class="font-bold">20 plays</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="font-semibold">Reward Per Play:</span>
                                <span id="colorGame-reward" class="font-bold">10 points</span>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <button onclick="editGameSettings('colorGame')" class="btn btn-primary w-full">
                                Configure Color Game
                            </button>
                        </div>
                    </div>
                    
                    <!-- Watch Video Card -->
                    <div class="game-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <div class="bg-blue-500 text-white p-3 rounded-lg mr-3">
                                    <i data-lucide="video" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <h2 class="text-xl font-bold">Watch Video</h2>
                                    <p class="text-sm text-gray-500">Earn by watching ads</p>
                                </div>
                            </div>
                            <span id="watchVideo-status" class="status-badge status-visible">Visible</span>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="font-semibold">Daily Time Limit:</span>
                                <span id="watchVideo-time-limit" class="font-bold">30 minutes</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="font-semibold">Daily Play Limit:</span>
                                <span id="watchVideo-daily-limit" class="font-bold">10 videos</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="font-semibold">Reward Per Video:</span>
                                <span id="watchVideo-reward" class="font-bold">15 points</span>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <button onclick="editGameSettings('watchVideo')" class="btn btn-primary w-full">
                                Configure Watch Video
                            </button>
                        </div>
                    </div>
                    
                    <!-- Ludo Dice Card -->
                    <div class="game-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <div class="bg-green-500 text-white p-3 rounded-lg mr-3">
                                    <i data-lucide="dice-5" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <h2 class="text-xl font-bold">Ludo Dice</h2>
                                    <p class="text-sm text-gray-500">Roll dice to win points</p>
                                </div>
                            </div>
                            <span id="ludoDice-status" class="status-badge status-visible">Visible</span>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="font-semibold">Daily Time Limit:</span>
                                <span id="ludoDice-time-limit" class="font-bold">60 minutes</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="font-semibold">Daily Play Limit:</span>
                                <span id="ludoDice-daily-limit" class="font-bold">50 plays</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="font-semibold">Reward Per Play:</span>
                                <span id="ludoDice-reward" class="font-bold">5 points</span>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <button onclick="editGameSettings('ludoDice')" class="btn btn-primary w-full">
                                Configure Ludo Dice
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Game Statistics</h2>
                    <div id="games-stats-table" class="overflow-x-auto">
                        Loading...
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow mt-6">
                    <h2 class="text-xl font-bold mb-4">Global Game Settings</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block font-semibold mb-2">Default Daily Time Limit (minutes)</label>
                            <input type="number" id="global-daily-limit" class="input-field" placeholder="e.g., 60">
                            <p class="text-sm text-gray-500 mt-1">Applied to new games when created</p>
                        </div>
                        <div>
                            <label class="block font-semibold mb-2">Default Daily Play Limit</label>
                            <input type="number" id="global-play-limit" class="input-field" placeholder="e.g., 20">
                            <p class="text-sm text-gray-500 mt-1">Default daily plays limit</p>
                        </div>
                    </div>
                    <button onclick="saveGlobalGameSettings()" class="btn btn-primary mt-4">Save Global Settings</button>
                </div>
            `;
            
            await loadGamesData();
            await loadGamesStats();
        }

        async function loadGamesData() {
            try {
                const gamesSnap = await getDoc(doc(db, "config", "games"));
                const gamesConfig = gamesSnap.exists() ? gamesSnap.data() : {};
                
                // Default configurations if not exists
                const defaultConfig = {
                    colorGame: {
                        name: "Color Game",
                        dailyTimeLimit: 60,
                        sessionTimeLimit: 10,
                        cooldownPeriod: 30,
                        dailyPlayLimit: 20,
                        rewardPerPlay: 10,
                        visible: true,
                        order: 1
                    },
                    watchVideo: {
                        name: "Watch Video",
                        dailyTimeLimit: 30,
                        sessionTimeLimit: 5,
                        cooldownPeriod: 10,
                        dailyPlayLimit: 10,
                        rewardPerPlay: 15,
                        visible: true,
                        order: 2
                    },
                    ludoDice: {
                        name: "Ludo Dice",
                        dailyTimeLimit: 60,
                        sessionTimeLimit: 15,
                        cooldownPeriod: 20,
                        dailyPlayLimit: 50,
                        rewardPerPlay: 5,
                        visible: true,
                        order: 3
                    },
                    globalSettings: {
                        defaultDailyLimit: 60,
                        defaultPlayLimit: 20
                    }
                };
                
                // Merge with existing config
                const config = { ...defaultConfig, ...gamesConfig };
                
                // Update display
                ['colorGame', 'watchVideo', 'ludoDice'].forEach(gameId => {
                    const game = config[gameId] || defaultConfig[gameId];
                    const statusEl = document.getElementById(`${gameId}-status`);
                    const timeLimitEl = document.getElementById(`${gameId}-time-limit`);
                    const dailyLimitEl = document.getElementById(`${gameId}-daily-limit`);
                    const rewardEl = document.getElementById(`${gameId}-reward`);
                    
                    if (statusEl) {
                        statusEl.textContent = game.visible ? 'Visible' : 'Hidden';
                        statusEl.className = `status-badge ${game.visible ? 'status-visible' : 'status-hidden'}`;
                    }
                    if (timeLimitEl) timeLimitEl.textContent = `${game.dailyTimeLimit || 0} minutes`;
                    if (dailyLimitEl) dailyLimitEl.textContent = `${game.dailyPlayLimit || 0} plays`;
                    if (rewardEl) rewardEl.textContent = `${game.rewardPerPlay || 0} points`;
                });
                
                // Update global settings
                if (config.globalSettings) {
                    document.getElementById('global-daily-limit').value = config.globalSettings.defaultDailyLimit || 60;
                    document.getElementById('global-play-limit').value = config.globalSettings.defaultPlayLimit || 20;
                }
                
                lucide.createIcons();
            } catch (error) {
                console.error("Error loading games data:", error);
                showAlert("âŒ Error loading game configurations", true);
            }
        }

        async function loadGamesStats() {
            try {
                const gamesSnap = await getDoc(doc(db, "config", "games"));
                const gamesConfig = gamesSnap.exists() ? gamesSnap.data() : {};
                
                // Get today's stats
                const today = new Date().toISOString().split('T')[0];
                const todayStats = gamesConfig.dailyStats?.[today] || {};
                
                // Get all time stats
                const allTimeStats = gamesConfig.allTimeStats || {};
                
                let html = `<table class="w-full text-sm text-left text-gray-600">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th class="px-6 py-3">Game</th>
                            <th class="px-6 py-3">Today's Plays</th>
                            <th class="px-6 py-3">Today's Users</th>
                            <th class="px-6 py-3">Today's Points</th>
                            <th class="px-6 py-3">Total Plays</th>
                            <th class="px-6 py-3">Total Users</th>
                            <th class="px-6 py-3">Total Points</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                const games = [
                    { id: 'colorGame', name: 'Color Game' },
                    { id: 'watchVideo', name: 'Watch Video' },
                    { id: 'ludoDice', name: 'Ludo Dice' }
                ];
                
                let todayTotalPlays = 0;
                let todayTotalUsers = 0;
                let todayTotalPoints = 0;
                let allTimeTotalPlays = 0;
                let allTimeTotalUsers = 0;
                let allTimeTotalPoints = 0;
                
                games.forEach(game => {
                    const todayGameStats = todayStats[game.id] || { playCount: 0, userCount: 0 };
                    const allTimeGameStats = allTimeStats[game.id] || { playCount: 0, userCount: 0 };
                    const gameConfig = gamesConfig[game.id] || {};
                    const rewardPerPlay = gameConfig.rewardPerPlay || 0;
                    
                    const todayPoints = todayGameStats.playCount * rewardPerPlay;
                    const allTimePoints = allTimeGameStats.playCount * rewardPerPlay;
                    
                    todayTotalPlays += todayGameStats.playCount;
                    todayTotalUsers += todayGameStats.userCount;
                    todayTotalPoints += todayPoints;
                    allTimeTotalPlays += allTimeGameStats.playCount;
                    allTimeTotalUsers += allTimeGameStats.userCount;
                    allTimeTotalPoints += allTimePoints;
                    
                    html += `<tr class="bg-white border-b">
                        <td class="px-6 py-4 font-semibold">${game.name}</td>
                        <td class="px-6 py-4">${todayGameStats.playCount}</td>
                        <td class="px-6 py-4">${todayGameStats.userCount}</td>
                        <td class="px-6 py-4">${todayPoints}</td>
                        <td class="px-6 py-4">${allTimeGameStats.playCount}</td>
                        <td class="px-6 py-4">${allTimeGameStats.userCount}</td>
                        <td class="px-6 py-4">${allTimePoints}</td>
                    </tr>`;
                });
                
                // Add totals row
                html += `<tr class="bg-gray-50 font-bold">
                    <td class="px-6 py-4">TOTAL</td>
                    <td class="px-6 py-4">${todayTotalPlays}</td>
                    <td class="px-6 py-4">${todayTotalUsers}</td>
                    <td class="px-6 py-4">${todayTotalPoints}</td>
                    <td class="px-6 py-4">${allTimeTotalPlays}</td>
                    <td class="px-6 py-4">${allTimeTotalUsers}</td>
                    <td class="px-6 py-4">${allTimeTotalPoints}</td>
                </tr>`;
                
                html += `</tbody></table>`;
                document.getElementById('games-stats-table').innerHTML = html;
            } catch (error) {
                console.error("Error loading game stats:", error);
                document.getElementById('games-stats-table').innerHTML = 
                    `<p class="text-center text-gray-500">Error loading game statistics</p>`;
            }
        }

        async function editGameSettings(gameId) {
            currentEditingGameId = gameId;
            
            try {
                const gamesSnap = await getDoc(doc(db, "config", "games"));
                const gamesConfig = gamesSnap.exists() ? gamesSnap.data() : {};
                
                const gameConfig = gamesConfig[gameId] || {};
                const gameNames = {
                    'colorGame': 'Color Game',
                    'watchVideo': 'Watch Video',
                    'ludoDice': 'Ludo Dice'
                };
                
                // Set modal title
                document.getElementById('edit-game-title').textContent = gameNames[gameId] || gameId;
                document.getElementById('edit-game-description').textContent = 
                    gameId === 'watchVideo' ? 'Configure video watching limits and rewards' : 
                    gameId === 'colorGame' ? 'Configure color matching game settings' :
                    'Configure dice game settings';
                
                // Set form values
                document.getElementById('edit-game-time-limit').value = gameConfig.dailyTimeLimit || 60;
                document.getElementById('edit-game-session-limit').value = gameConfig.sessionTimeLimit || 10;
                document.getElementById('edit-game-cooldown').value = gameConfig.cooldownPeriod || 30;
                document.getElementById('edit-game-reward-per-play').value = gameConfig.rewardPerPlay || 10;
                document.getElementById('edit-game-daily-limit').value = gameConfig.dailyPlayLimit || 20;
                document.getElementById('edit-game-visible').checked = gameConfig.visible !== false;
                document.getElementById('edit-game-order').value = gameConfig.order || 1;
                
                // Show modal
                document.getElementById('edit-game-modal').style.display = 'flex';
            } catch (error) {
                console.error("Error loading game settings:", error);
                showAlert("âŒ Error loading game settings", true);
            }
        }

        function closeEditGameModal() {
            document.getElementById('edit-game-modal').style.display = 'none';
            currentEditingGameId = null;
        }

        async function saveGameSettings() {
            if (!currentEditingGameId) return;
            
            const timeLimit = parseInt(document.getElementById('edit-game-time-limit').value) || 0;
            const sessionLimit = parseInt(document.getElementById('edit-game-session-limit').value) || 0;
            const cooldown = parseInt(document.getElementById('edit-game-cooldown').value) || 0;
            const rewardPerPlay = parseInt(document.getElementById('edit-game-reward-per-play').value) || 0;
            const dailyLimit = parseInt(document.getElementById('edit-game-daily-limit').value) || 0;
            const isVisible = document.getElementById('edit-game-visible').checked;
            const order = parseInt(document.getElementById('edit-game-order').value) || 1;
            
            if (timeLimit < 0 || sessionLimit < 0 || cooldown < 0 || rewardPerPlay < 0 || dailyLimit < 0) {
                showAlert("âŒ Please enter valid positive numbers for all fields");
                return;
            }
            
            if (order < 1 || order > 10) {
                showAlert("âŒ Order must be between 1 and 10");
                return;
            }
            
            loader.style.display = 'flex';
            try {
                const gameRef = doc(db, "config", "games");
                const gameSnap = await getDoc(gameRef);
                const currentData = gameSnap.exists() ? gameSnap.data() : {};
                
                const updateData = {
                    [currentEditingGameId]: {
                        name: currentEditingGameId === 'colorGame' ? 'Color Game' : 
                              currentEditingGameId === 'watchVideo' ? 'Watch Video' : 'Ludo Dice',
                        dailyTimeLimit: timeLimit,
                        sessionTimeLimit: sessionLimit,
                        cooldownPeriod: cooldown,
                        rewardPerPlay: rewardPerPlay,
                        dailyPlayLimit: dailyLimit,
                        visible: isVisible,
                        order: order,
                        updatedAt: serverTimestamp()
                    }
                };
                
                await setDoc(gameRef, updateData, { merge: true });
                
                showToast("âœ… Game settings saved successfully!");
                closeEditGameModal();
                await loadGamesData();
                await loadGamesStats();
                if (document.getElementById('dashboard').classList.contains('active')) {
                    loadGameStats();
                }
            } catch (error) {
                console.error("Error saving game settings:", error);
                showAlert("âŒ Error saving game settings: " + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        async function saveGlobalGameSettings() {
            const defaultDailyLimit = parseInt(document.getElementById('global-daily-limit').value) || 60;
            const defaultPlayLimit = parseInt(document.getElementById('global-play-limit').value) || 20;
            
            if (defaultDailyLimit < 0 || defaultPlayLimit < 0) {
                showAlert("âŒ Please enter valid positive numbers");
                return;
            }
            
            loader.style.display = 'flex';
            try {
                const gameRef = doc(db, "config", "games");
                const updateData = {
                    globalSettings: {
                        defaultDailyLimit: defaultDailyLimit,
                        defaultPlayLimit: defaultPlayLimit,
                        updatedAt: serverTimestamp()
                    }
                };
                
                await setDoc(gameRef, updateData, { merge: true });
                showToast("âœ… Global game settings saved!");
            } catch (error) {
                console.error("Error saving global settings:", error);
                showAlert("âŒ Error saving global settings", true);
            } finally {
                loader.style.display = 'none';
            }
        }

        async function resetAllGameStats() {
            showConfirm("Are you sure you want to reset all game statistics? This action cannot be undone.", async () => {
                loader.style.display = 'flex';
                try {
                    const gameRef = doc(db, "config", "games");
                    const gameSnap = await getDoc(gameRef);
                    const currentData = gameSnap.exists() ? gameSnap.data() : {};
                    
                    // Keep game configurations but reset stats
                    const updateData = {
                        ...currentData,
                        dailyStats: {},
                        allTimeStats: {},
                        updatedAt: serverTimestamp()
                    };
                    
                    await setDoc(gameRef, updateData);
                    
                    showToast("âœ… All game statistics reset successfully!");
                    await loadGamesStats();
                    if (document.getElementById('dashboard').classList.contains('active')) {
                        loadGameStats();
                    }
                } catch (error) {
                    console.error("Error resetting game stats:", error);
                    showAlert("âŒ Error resetting game statistics", true);
                } finally {
                    loader.style.display = 'none';
                }
            });
        }

        // Notifications Functions
        function loadNotifications() {
            const page = document.getElementById('notifications');
            page.innerHTML = `
                <h1 class="text-3xl font-bold mb-6">Send Notification</h1>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="stat-card p-6">
                        <h2 class="text-xl font-bold mb-4">Send to All Users</h2>
                        <div class="mb-4">
                            <label for="notification-title" class="block font-semibold mb-2">Title</label>
                            <input type="text" id="notification-title" class="input-field" placeholder="Notification title">
                        </div>
                        <div class="mb-6">
                            <label for="notification-message" class="block font-semibold mb-2">Message</label>
                            <textarea id="notification-message" rows="4" class="input-field" placeholder="Notification message"></textarea>
                        </div>
                        <button id="send-notification-btn" class="btn btn-primary w-full">Send to All Users</button>
                    </div>
                    
                    <div class="stat-card p-6">
                        <h2 class="text-xl font-bold mb-4">Telegram Bot Configuration</h2>
                        <div class="mb-4">
                            <label for="telegram-bot-token" class="block font-semibold mb-2">Bot Token</label>
                            <input type="text" id="telegram-bot-token" class="input-field" placeholder="Enter bot token">
                        </div>
                        <div class="mb-6">
                            <label for="telegram-chat-id" class="block font-semibold mb-2">Chat ID</label>
                            <input type="text" id="telegram-chat-id" class="input-field" placeholder="Enter chat ID">
                        </div>
                        <button onclick="testTelegramConnection()" class="btn btn-warning w-full mb-2">Test Connection</button>
                        <button onclick="saveTelegramConfig()" class="btn btn-success w-full">Save Configuration</button>
                    </div>
                </div>
                
                <div class="mt-8">
                    <h2 class="text-2xl font-bold mb-4">Notification History</h2>
                    <div id="notification-history" class="bg-white shadow rounded-lg p-4">
                        Loading...
                    </div>
                </div>
            `;
            
            document.getElementById('send-notification-btn').addEventListener('click', sendNotification);
            loadNotificationHistory();
            loadTelegramConfig();
        }

        async function sendNotification() {
            const title = document.getElementById('notification-title').value;
            const message = document.getElementById('notification-message').value;
            
            if (!title || !message) {
                showAlert("Please enter both title and message.");
                return;
            }
            
            loader.style.display = 'flex';
            try {
                // Save to Firebase
                await addDoc(collection(db, "notifications"), {
                    title,
                    message,
                    createdAt: serverTimestamp(),
                    sentToAll: true
                });
                
                // Send to Telegram if configured
                await sendTelegramNotification(title, message);
                
                showToast("âœ… Notification sent successfully!");
                document.getElementById('notification-title').value = '';
                document.getElementById('notification-message').value = '';
                loadNotificationHistory();
            } catch (error) {
                console.error("Error sending notification:", error);
                showAlert("âŒ Error sending notification: " + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        async function sendTelegramNotification(title, message) {
            const configSnap = await getDoc(doc(db, "config", "telegram"));
            if (!configSnap.exists()) return;
            
            const config = configSnap.data();
            if (!config.botToken || !config.chatId) return;
            
            const telegramMessage = `*${title}*\n\n${message}`;
            
            try {
                const response = await fetch(`https://api.telegram.org/bot${config.botToken}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: config.chatId,
                        text: telegramMessage,
                        parse_mode: 'Markdown'
                    })
                });
                
                const result = await response.json();
                if (!result.ok) {
                    console.error("Telegram API error:", result);
                    throw new Error(result.description || 'Telegram API error');
                }
            } catch (error) {
                console.error("Error sending to Telegram:", error);
                throw error;
            }
        }

        async function loadNotificationHistory() {
            const notificationsSnap = await getDocs(query(
                collection(db, "notifications"), 
                orderBy("createdAt", "desc"), 
                limit(10)
            ));
            
            let html = `<table class="w-full">
                <thead><tr><th>Title</th><th>Message</th><th>Sent At</th></tr></thead>
                <tbody>`;
            
            if (notificationsSnap.empty) {
                html += `<tr><td colspan="3" class="text-center py-4 text-gray-500">No notifications sent yet</td></tr>`;
            } else {
                notificationsSnap.forEach(doc => {
                    const notification = doc.data();
                    const sentAt = notification.createdAt?.toDate().toLocaleString() || 'N/A';
                    html += `<tr class="border-b">
                        <td class="py-2 font-semibold">${notification.title}</td>
                        <td class="py-2">${notification.message}</td>
                        <td class="py-2 text-gray-500 text-sm">${sentAt}</td>
                    </tr>`;
                });
            }
            
            html += `</tbody></table>`;
            document.getElementById('notification-history').innerHTML = html;
        }

        async function loadTelegramConfig() {
            const configSnap = await getDoc(doc(db, "config", "telegram"));
            if (configSnap.exists()) {
                const config = configSnap.data();
                document.getElementById('telegram-bot-token').value = config.botToken || '';
                document.getElementById('telegram-chat-id').value = config.chatId || '';
            }
        }

        async function saveTelegramConfig() {
            const botToken = document.getElementById('telegram-bot-token').value;
            const chatId = document.getElementById('telegram-chat-id').value;
            
            if (!botToken || !chatId) {
                showAlert("Please enter both Bot Token and Chat ID.");
                return;
            }
            
            loader.style.display = 'flex';
            try {
                await setDoc(doc(db, "config", "telegram"), {
                    botToken,
                    chatId,
                    updatedAt: serverTimestamp()
                });
                showToast("âœ… Telegram configuration saved successfully!");
            } catch (error) {
                console.error("Error saving Telegram config:", error);
                showAlert("âŒ Error saving configuration: " + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        async function testTelegramConnection() {
            const botToken = document.getElementById('telegram-bot-token').value;
            const chatId = document.getElementById('telegram-chat-id').value;
            
            if (!botToken || !chatId) {
                showAlert("Please enter both Bot Token and Chat ID to test.");
                return;
            }
            
            loader.style.display = 'flex';
            try {
                // Test bot token
                const botResponse = await fetch(`https://api.telegram.org/bot${botToken}/getMe`);
                const botResult = await botResponse.json();
                
                if (!botResult.ok) {
                    showAlert("âŒ Bot connection failed: " + botResult.description, true);
                    return;
                }
                
                // Test sending message
                const messageResponse = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: "âœ… Test message from CashReward Admin Panel",
                        parse_mode: 'Markdown'
                    })
                });
                
                const messageResult = await messageResponse.json();
                if (messageResult.ok) {
                    showAlert("âœ… Telegram connection successful! Test message sent.");
                } else {
                    showAlert("âŒ Failed to send test message: " + messageResult.description, true);
                }
            } catch (error) {
                showAlert("âŒ Error testing connection: " + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        // Settings Functions with Reset History Button
        async function loadSettings() {
            const page = document.getElementById('settings');
            page.innerHTML = `
                <h1 class="text-3xl font-bold mb-6">App Settings</h1>
                <div class="space-y-8">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4">General & Payment</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="font-semibold">Min Withdrawal (Coins)</label>
                                <input type="number" id="minWithdrawal" class="input-field">
                            </div>
                            <div>
                                <label class="font-semibold">Daily Ad Watch Limit</label>
                                <input type="number" id="dailyAdLimit" class="input-field" value="100">
                                <p class="text-sm text-gray-500 mt-1">Maximum ads a user can watch per day</p>
                            </div>
                            <div>
                                <label class="font-semibold">Ad Watch Reward</label>
                                <input type="number" id="adWatchReward" class="input-field">
                            </div>
                            <div>
                                <label class="font-semibold">Color Game Reward</label>
                                <input type="number" id="colorGameReward" class="input-field">
                            </div>
                            <div>
                                <label class="font-semibold">Coin Value</label>
                                <div class="flex items-center space-x-2">
                                    <input type="number" id="coinValueCoins" class="input-field" placeholder="Coins">
                                    <span class="text-gray-500">=</span>
                                    <input type="number" id="coinValueInr" class="input-field" placeholder="â‚¹ INR">
                                </div>
                            </div>
                            <div>
                                <label class="font-semibold">Payment Methods (comma separated)</label>
                                <input type="text" id="paymentMethods" class="input-field" placeholder="UPI, Paytm, PhonePe">
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4">IP Geolocation & Country Restrictions</h2>
                        <div class="mb-4">
                            <label class="font-semibold">IPinfo API Token</label>
                            <div class="flex items-center space-x-2">
                                <input type="text" id="ipinfoApiToken" class="input-field" placeholder="Enter IPinfo API token">
                                <button onclick="testIpinfoApi()" class="btn btn-secondary">Test API</button>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">
                                Leave blank to disable country detection. Get free token from 
                                <a href="https://ipinfo.io/signup" target="_blank" class="text-blue-500 hover:underline">ipinfo.io/signup</a>
                            </p>
                        </div>
                        <div class="mb-4">
                            <label class="font-semibold">Allowed Countries (comma separated, empty means all allowed)</label>
                            <input type="text" id="allowedCountries" class="input-field" placeholder="bd, in, pk, us, uk">
                            <p class="text-sm text-gray-500 mt-1">
                                Enter country codes separated by commas. 
                                <span class="font-semibold text-blue-600">If both API token and this field are empty, all countries will be allowed.</span>
                            </p>
                        </div>
                        <div class="mb-4">
                            <label class="font-semibold">Blocked Country Message</label>
                            <textarea id="blockedCountryMessage" class="input-field h-24" placeholder="Message shown to users from blocked countries"></textarea>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h3 class="font-semibold text-blue-800 mb-2">How Country Restrictions Work:</h3>
                            <ul class="list-disc list-inside text-sm text-blue-700 space-y-1">
                                <li>If API token is empty â†’ Country detection is disabled</li>
                                <li>If allowed countries list is empty â†’ All countries are allowed</li>
                                <li>If both are empty â†’ All countries are allowed (no restrictions)</li>
                                <li>If API token exists and allowed countries list has values â†’ Only listed countries allowed</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold">Website Visit Management</h2>
                            <button onclick="resetWebsiteVisitHistory()" class="btn btn-danger">Reset All History</button>
                        </div>
                        <p class="text-sm text-gray-500 mb-4">Configure websites for "Visit & Earn" section and reset visit history.</p>
                        
                        <div id="websites-to-visit-list" class="space-y-3 mb-4">
                            <!-- Websites will be loaded here -->
                        </div>
                        
                        <button onclick="addNewWebsite()" class="btn btn-primary mb-4">+ Add New Website</button>
                        <button onclick="saveWebsiteConfig()" class="btn btn-success ml-2">Save Websites</button>
                        
                        <div class="mt-4 text-sm text-gray-600">
                            <p><strong>Field descriptions:</strong></p>
                            <ul class="list-disc pl-5 mt-2">
                                <li><strong>Name:</strong> Website display name (e.g., Google)</li>
                                <li><strong>Link:</strong> Full URL (e.g., https://www.google.com)</li>
                                <li><strong>Reward:</strong> Points to award (e.g., 10)</li>
                                <li><strong>Timer:</strong> Seconds user must wait on site (e.g., 30)</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4">Special Ad Click Task</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="font-semibold">Show after # Ads</label>
                                <input type="number" id="watchAdSpecialTaskCount" class="input-field">
                            </div>
                            <div>
                                <label class="font-semibold">Task Reward</label>
                                <input type="number" id="watchAdSpecialTaskReward" class="input-field">
                            </div>
                            <div>
                                <label class="font-semibold">Wait Timer (seconds)</label>
                                <input type="number" id="watchAdSpecialTaskTimer" class="input-field">
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4">Referral System</h2>
                        <div class="mb-4">
                            <label class="font-semibold">Referral Bonus</label>
                            <input type="number" id="referralBonus" class="input-field">
                        </div>
                        <div class="mb-4">
                            <label class="font-semibold">Referral Rules (one per line)</label>
                            <textarea id="referralRules" class="input-field h-24"></textarea>
                        </div>
                        <div>
                            <label class="font-semibold">Share Text ({CODE} & {APP_LINK})</label>
                            <textarea id="referralShareText" class="input-field h-24"></textarea>
                        </div>
                    </div>
                    
                    <div id="dynamic-lists"></div>
                </div>
                <button id="save-settings-btn" class="btn btn-primary mt-8 px-8 py-3">Save All Settings</button>
            `;
            
            // Load existing settings
            const configSnap = await getDoc(doc(db, "config", "main"));
            const config = configSnap.data() || {};
            
            // Populate settings fields
            if (configSnap.exists()) {
                document.getElementById('minWithdrawal').value = config.minWithdrawal || '';
                document.getElementById('dailyAdLimit').value = config.dailyAdLimit || 100;
                document.getElementById('adWatchReward').value = config.adWatchReward || '';
                document.getElementById('colorGameReward').value = config.colorGameReward || '';
                document.getElementById('coinValueCoins').value = config.coinValueCoins || '';
                document.getElementById('coinValueInr').value = config.coinValueInr || '';
                document.getElementById('paymentMethods').value = (config.paymentMethods || []).join(',');
                document.getElementById('watchAdSpecialTaskCount').value = config.watchAdSpecialTaskCount || '';
                document.getElementById('watchAdSpecialTaskReward').value = config.watchAdSpecialTaskReward || '';
                document.getElementById('watchAdSpecialTaskTimer').value = config.watchAdSpecialTaskTimer || '';
                document.getElementById('referralBonus').value = config.referralBonus || '';
                document.getElementById('referralRules').value = (config.referralRules || []).join('\n');
                document.getElementById('referralShareText').value = config.referralShareText || '';
                document.getElementById('ipinfoApiToken').value = config.ipinfoApiToken || '';
                document.getElementById('allowedCountries').value = (config.allowedCountries || []).join(',');
                document.getElementById('blockedCountryMessage').value = config.blockedCountryMessage || 'Sorry, this app is not available in your country.';
            }
            
            // Load websites
            await loadWebsitesConfig();
            
            // Render dynamic lists
            renderListEditor('sliderBanners', config.sliderBanners, ['img', 'link']);
            renderListEditor('socialTasks', config.socialTasks, ['name', 'link', 'icon', 'reward']);
            
            // Add event listener for save button
            document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
        }

        async function loadWebsitesConfig() {
            try {
                const configSnap = await getDoc(doc(db, "config", "main"));
                const config = configSnap.data() || {};
                const websites = config.websitesToVisit || [];
                
                const container = document.getElementById('websites-to-visit-list');
                container.innerHTML = '';
                
                if (websites.length === 0) {
                    // Add default websites
                    const defaultWebsites = [
                        { name: "Google", link: "https://www.google.com", reward: 10, timer: 30 },
                        { name: "YouTube", link: "https://www.youtube.com", reward: 15, timer: 45 },
                        { name: "Facebook", link: "https://www.facebook.com", reward: 20, timer: 60 }
                    ];
                    
                    defaultWebsites.forEach((site, index) => {
                        container.innerHTML += `
                            <div class="website-item">
                                <div class="website-field">
                                    <input type="text" placeholder="Website Name" value="${site.name}" data-field="name">
                                </div>
                                <div class="website-field">
                                    <input type="url" placeholder="https://example.com" value="${site.link}" data-field="link">
                                </div>
                                <div class="website-field">
                                    <input type="number" placeholder="Reward" value="${site.reward}" data-field="reward">
                                </div>
                                <div class="website-field">
                                    <input type="number" placeholder="Timer (sec)" value="${site.timer}" data-field="timer">
                                </div>
                                <button onclick="removeWebsite(this)" class="btn btn-danger">Ã—</button>
                            </div>
                        `;
                    });
                } else {
                    websites.forEach((site, index) => {
                        container.innerHTML += `
                            <div class="website-item">
                                <div class="website-field">
                                    <input type="text" placeholder="Website Name" value="${site.name}" data-field="name">
                                </div>
                                <div class="website-field">
                                    <input type="url" placeholder="https://example.com" value="${site.link}" data-field="link">
                                </div>
                                <div class="website-field">
                                    <input type="number" placeholder="Reward" value="${site.reward}" data-field="reward">
                                </div>
                                <div class="website-field">
                                    <input type="number" placeholder="Timer (sec)" value="${site.timer}" data-field="timer">
                                </div>
                                <button onclick="removeWebsite(this)" class="btn btn-danger">Ã—</button>
                            </div>
                        `;
                    });
                }
            } catch (error) {
                console.error("Error loading website config:", error);
            }
        }

        function addNewWebsite() {
            const container = document.getElementById('websites-to-visit-list');
            container.innerHTML += `
                <div class="website-item">
                    <div class="website-field">
                        <input type="text" placeholder="Website Name" value="" data-field="name">
                    </div>
                    <div class="website-field">
                        <input type="url" placeholder="https://example.com" value="" data-field="link">
                    </div>
                    <div class="website-field">
                        <input type="number" placeholder="Reward" value="10" data-field="reward">
                    </div>
                    <div class="website-field">
                        <input type="number" placeholder="Timer (sec)" value="30" data-field="timer">
                    </div>
                    <button onclick="removeWebsite(this)" class="btn btn-danger">Ã—</button>
                </div>
            `;
        }

        function removeWebsite(button) {
            const item = button.closest('.website-item');
            if (item) {
                item.remove();
            }
        }

        async function saveWebsiteConfig() {
            loader.style.display = 'flex';
            try {
                // Get website configurations from the UI
                const websites = [];
                const websiteItems = document.querySelectorAll('#websites-to-visit-list .website-item');
                
                websiteItems.forEach(item => {
                    const name = item.querySelector('[data-field="name"]').value.trim();
                    const link = item.querySelector('[data-field="link"]').value.trim();
                    const reward = parseInt(item.querySelector('[data-field="reward"]').value) || 10;
                    const timer = parseInt(item.querySelector('[data-field="timer"]').value) || 30;
                    
                    if (name && link) {
                        websites.push({
                            name: name,
                            link: link,
                            reward: reward,
                            timer: timer
                        });
                    }
                });
                
                // Save to Firebase
                const configRef = doc(db, "config", "main");
                await updateDoc(configRef, {
                    websitesToVisit: websites,
                    updatedAt: serverTimestamp()
                });
                
                showToast('âœ… Website configurations saved successfully!');
            } catch (error) {
                console.error("Error saving website config:", error);
                showAlert('âŒ Error saving website configurations: ' + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        async function resetWebsiteVisitHistory() {
            showConfirm("Are you sure you want to reset website visit history for ALL users? This will allow all users to visit websites again for rewards.", async () => {
                loader.style.display = 'flex';
                try {
                    // Get all users
                    const usersSnap = await getDocs(collection(db, "users"));
                    const batch = writeBatch(db);
                    
                    // Reset visitedWebsitesToday for each user (field name correction)
                    usersSnap.forEach((userDoc) => {
                        const userRef = doc(db, "users", userDoc.id);
                        batch.update(userRef, { 
                            visitedWebsitesToday: [], // Correct field name
                            lastWebsiteVisitDate: '1970-01-01' // Reset the date too
                        });
                    });
                    
                    await batch.commit();
                    showToast("âœ… Website visit history reset successfully for all users!");
                } catch (error) {
                    console.error("Error resetting website history:", error);
                    showAlert("âŒ Error resetting website history: " + error.message, true);
                } finally {
                    loader.style.display = 'none';
                }
            });
        }

        async function testIpinfoApi() {
            const apiToken = document.getElementById('ipinfoApiToken').value.trim();
            
            if (!apiToken) {
                showAlert("Please enter an API token to test.");
                return;
            }
            
            loader.style.display = 'flex';
            try {
                // Test the API with a sample IP
                const response = await fetch(`https://api.ipinfo.io/lite/8.8.8.8?token=${apiToken}`);
                
                if (!response.ok) {
                    throw new Error(`API returned status: ${response.status}`);
                }
                
                const data = await response.text();
                const country = data.trim(); // IPinfo lite API returns just the country code
                
                if (country && country.length === 2) {
                    showAlert(`âœ… API Test Successful! Detected country: ${country}`);
                } else {
                    showAlert(`âš ï¸ API responded but didn't return a valid country code. Response: "${data}"`);
                }
            } catch (error) {
                console.error("IPinfo API test error:", error);
                showAlert(`âŒ API Test Failed: ${error.message}. Check your token.`, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        function renderListEditor(key, items, fields) {
            const container = document.getElementById('dynamic-lists');
            if (!container) return;
            
            let listHTML = `
                <div class="bg-white p-6 rounded-lg shadow mb-8">
                    <h2 class="text-xl font-bold mb-4 capitalize">${key.replace(/([A-Z])/g, ' $1')}</h2>
                    <div id="${key}-list" class="space-y-2">`;
            
            (items || []).forEach((item, index) => {
                listHTML += `<div class="flex gap-2 items-center border p-2 rounded">`;
                fields.forEach(field => {
                    let placeholder = field;
                    if (key === 'socialTasks' && field === 'icon') {
                        placeholder = 'icon name or image URL';
                    }
                    listHTML += `<input type="text" class="input-field text-sm" placeholder="${placeholder}" 
                               data-key="${key}" data-index="${index}" data-field="${field}" value="${item[field] || ''}">`;
                });
                listHTML += `<button class="remove-item-btn text-red-500 font-bold text-xl p-1" 
                             data-key="${key}" data-index="${index}">&times;</button></div>`;
            });
            
            listHTML += `</div>
                <button class="add-item-btn mt-4 text-sm btn btn-primary" data-key="${key}">+ Add New</button>
                </div>`;
            
            container.innerHTML += listHTML;

            // Add event listeners
            document.querySelectorAll('.add-item-btn, .remove-item-btn').forEach(btn => {
                btn.addEventListener('click', handleListEdit);
            });
        }

        function handleListEdit(e) {
            const newConfig = getSettingsFromUI();
            const { key, index } = e.target.dataset;
            
            if (e.target.classList.contains('add-item-btn')) {
                if (!newConfig[key]) newConfig[key] = [];
                newConfig[key].push({});
            } else {
                if (newConfig[key]) {
                    newConfig[key].splice(index, 1);
                }
            }
            renderSettings(newConfig);
        }

        function renderSettings(config) {
            // Clear dynamic lists
            document.getElementById('dynamic-lists').innerHTML = '';
            // Re-render with updated config
            renderListEditor('sliderBanners', config.sliderBanners, ['img', 'link']);
            renderListEditor('socialTasks', config.socialTasks, ['name', 'link', 'icon', 'reward']);
        }

        function getSettingsFromUI() {
            const newConfig = {};
            
            // Get all settings from inputs
            newConfig.minWithdrawal = parseInt(document.getElementById('minWithdrawal').value) || 0;
            newConfig.dailyAdLimit = parseInt(document.getElementById('dailyAdLimit').value) || 100;
            newConfig.adWatchReward = parseInt(document.getElementById('adWatchReward').value) || 0;
            newConfig.colorGameReward = parseInt(document.getElementById('colorGameReward').value) || 0;
            newConfig.coinValueCoins = parseInt(document.getElementById('coinValueCoins').value) || 0;
            newConfig.coinValueInr = parseInt(document.getElementById('coinValueInr').value) || 0;
            newConfig.watchAdSpecialTaskCount = parseInt(document.getElementById('watchAdSpecialTaskCount').value) || 0;
            newConfig.watchAdSpecialTaskReward = parseInt(document.getElementById('watchAdSpecialTaskReward').value) || 0;
            newConfig.watchAdSpecialTaskTimer = parseInt(document.getElementById('watchAdSpecialTaskTimer').value) || 0;
            newConfig.referralBonus = parseInt(document.getElementById('referralBonus').value) || 0;
            
            newConfig.paymentMethods = document.getElementById('paymentMethods').value.split(',').map(s => s.trim()).filter(Boolean);
            newConfig.referralRules = document.getElementById('referralRules').value.split('\n').map(s => s.trim()).filter(Boolean);
            newConfig.referralShareText = document.getElementById('referralShareText').value;
            newConfig.ipinfoApiToken = document.getElementById('ipinfoApiToken').value.trim();
            newConfig.allowedCountries = document.getElementById('allowedCountries').value.split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
            newConfig.blockedCountryMessage = document.getElementById('blockedCountryMessage').value;

            // Get dynamic lists
            ['sliderBanners', 'socialTasks'].forEach(key => {
                const listContainer = document.getElementById(`${key}-list`);
                if (!listContainer) return;
                newConfig[key] = [];
                const items = listContainer.children;
                for (let i = 0; i < items.length; i++) {
                    const inputs = items[i].querySelectorAll('input');
                    const newItem = {};
                    inputs.forEach(input => {
                        const value = input.value.trim();
                        const numericFields = ['reward'];
                        if (numericFields.includes(input.dataset.field) && !isNaN(value) && value !== '') {
                            newItem[input.dataset.field] = parseInt(value);
                        } else {
                            newItem[input.dataset.field] = value;
                        }
                    });
                    if (Object.values(newItem).some(val => val !== '')) {
                        newConfig[key].push(newItem);
                    }
                }
            });
            
            return newConfig;
        }

        async function saveSettings() {
            const newConfig = getSettingsFromUI();
            loader.style.display = 'flex';
            
            try {
                await setDoc(doc(db, "config", "main"), newConfig, { merge: true });
                showToast('âœ… Settings saved successfully!');
                loadUsers(); // Refresh users to show updated daily ad limit
            } catch (error) {
                console.error("Error saving settings:", error);
                showAlert('âŒ Error: Could not save settings.', true);
            } finally {
                loader.style.display = 'none';
            }
        }

        // User Point History Functions
        async function viewUserPointHistory(userId, userName) {
            currentViewingUserId = userId;
            document.getElementById('history-user-name').textContent = userName;
            document.getElementById('history-user-id').textContent = userId;
            
            loader.style.display = 'flex';
            try {
                const historySnap = await getDocs(query(
                    collection(db, "pointHistory"),
                    where("userId", "==", userId),
                    orderBy("timestamp", "desc")
                ));
                
                let totalPoints = 0;
                let html = '';
                
                if (historySnap.empty) {
                    html = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No point history found for this user</td></tr>`;
                } else {
                    historySnap.forEach(doc => {
                        const history = doc.data();
                        const points = history.points || 0;
                        if (points > 0) {
                            totalPoints += points;
                        }
                        
                        const taskLabels = {
                            'ad_watch': 'Ad Watch',
                            'color_game': 'Color Game',
                            'website_visit': 'Website Visit',
                            'referral': 'Referral Bonus',
                            'withdrawal': 'Withdrawal',
                            'admin_adjustment': 'Admin Adjustment',
                            'game_play': 'Game Play'
                        };
                        
                        const timestamp = history.timestamp?.toDate().toLocaleString() || 'N/A';
                        const pointsClass = points > 0 ? 'text-green-600' : 'text-red-600';
                        const country = history.country || 'N/A';
                        
                        html += `<tr class="border-b">
                            <td class="px-4 py-2 text-sm">${timestamp}</td>
                            <td class="px-4 py-2">${taskLabels[history.taskType] || history.taskType}</td>
                            <td class="px-4 py-2 font-semibold ${pointsClass}">${points > 0 ? '+' : ''}${points}</td>
                            <td class="px-4 py-2">${country}</td>
                            <td class="px-4 py-2 text-gray-600">${history.details || ''}</td>
                        </tr>`;
                    });
                }
                
                document.getElementById('total-points-earned').textContent = totalPoints;
                document.getElementById('user-point-history-body').innerHTML = html;
                document.getElementById('user-point-history-modal').style.display = 'flex';
            } catch (error) {
                console.error("Error loading point history:", error);
                showAlert("âŒ Error loading point history: " + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        function closePointHistoryModal() {
            document.getElementById('user-point-history-modal').style.display = 'none';
            currentViewingUserId = null;
        }

        // User Management Functions
        async function toggleUserBlock(userId, isBlocked) {
            showConfirm(`Are you sure you want to ${isBlocked ? 'unblock' : 'block'} this user?`, async () => {
                loader.style.display = 'flex';
                try {
                    await updateDoc(doc(db, "users", userId), { isBlocked: !isBlocked });
                    showToast(`âœ… User ${isBlocked ? 'unblocked' : 'blocked'} successfully!`);
                    loadUsers();
                } catch (error) {
                    console.error("Error updating user:", error);
                    showAlert("âŒ Error updating user status.", true);
                } finally {
                    loader.style.display = 'none';
                }
            });
        }

        async function resetDailyAds(userId) {
            showConfirm("Are you sure you want to reset daily ads for this user?", async () => {
                loader.style.display = 'flex';
                try {
                    await updateDoc(doc(db, "users", userId), { 
                        dailyAdCount: 0,
                        lastAdWatchDate: new Date().toISOString().split('T')[0]
                    });
                    showToast("âœ… Daily ads reset successfully!");
                    loadUsers();
                } catch (error) {
                    console.error("Error resetting daily ads:", error);
                    showAlert("âŒ Error resetting daily ads.", true);
                } finally {
                    loader.style.display = 'none';
                }
            });
        }

        // Point Editing Functions
        function openEditPointsModal(userId, userName, userEmail, currentBalance) {
            currentEditingUserId = userId;
            document.getElementById('edit-user-name').textContent = userName;
            document.getElementById('edit-user-email').textContent = userEmail;
            document.getElementById('edit-current-balance').textContent = currentBalance;
            document.getElementById('new-balance-input').value = currentBalance;
            document.getElementById('edit-points-modal').style.display = 'flex';
        }

        function closeEditPointsModal() {
            document.getElementById('edit-points-modal').style.display = 'none';
            currentEditingUserId = null;
        }

        async function saveUserPoints() {
            const newBalance = parseInt(document.getElementById('new-balance-input').value);
            
            if (isNaN(newBalance)) {
                showAlert("Please enter a valid number for the balance.");
                return;
            }
            
            loader.style.display = 'flex';
            try {
                // Get current balance and user data
                const userRef = doc(db, "users", currentEditingUserId);
                const userSnap = await getDoc(userRef);
                const userData = userSnap.data();
                const currentBalance = userData.balance || 0;
                
                // Update user balance
                await updateDoc(userRef, { balance: newBalance });
                
                // Add point history record
                await addDoc(collection(db, "pointHistory"), {
                    userId: currentEditingUserId,
                    userName: userData.name || 'Unknown',
                    userEmail: userData.email || '',
                    taskType: 'admin_adjustment',
                    points: newBalance - currentBalance,
                    details: `Admin adjusted balance from ${currentBalance} to ${newBalance}`,
                    timestamp: serverTimestamp(),
                    country: userData.country || 'N/A'
                });
                
                showToast("âœ… User points updated successfully!");
                closeEditPointsModal();
                loadUsers();
            } catch (error) {
                console.error("Error updating user points:", error);
                showAlert("âŒ Error updating user points: " + error.message, true);
            } finally {
                loader.style.display = 'none';
            }
        }

        // Withdrawal Processing Functions
        async function processWithdrawal(requestId, action) {
            showConfirm(`Are you sure you want to ${action} this withdrawal request?`, async () => {
                loader.style.display = 'flex';
                const batch = writeBatch(db);
                const requestRef = doc(db, "withdrawals", requestId);
                
                try {
                    // Get request data
                    const requestSnap = await getDoc(requestRef);
                    if (!requestSnap.exists()) {
                        throw new Error("Request not found");
                    }
                    
                    const requestData = requestSnap.data();
                    
                    // Update withdrawal status
                    batch.update(requestRef, { 
                        status: action,
                        processedAt: serverTimestamp()
                    });
                    
                    // If rejected, refund coins to user
                    if (action === 'rejected') {
                        const userRef = doc(db, "users", requestData.userId);
                        const userSnap = await getDoc(userRef);
                        
                        if (userSnap.exists()) {
                            const userData = userSnap.data();
                            const currentBalance = userData.balance || 0;
                            batch.update(userRef, { balance: currentBalance + requestData.amount });
                            
                            // Add point history for refund
                            await addDoc(collection(db, "pointHistory"), {
                                userId: requestData.userId,
                                userName: requestData.userName,
                                userEmail: userData.email || '',
                                taskType: 'withdrawal',
                                points: requestData.amount,
                                details: `Refund for rejected withdrawal #${requestId}`,
                                timestamp: serverTimestamp(),
                                country: requestData.country || 'N/A'
                            });
                        }
                    }
                    
                    await batch.commit();
                    showToast(`âœ… Withdrawal request ${action} successfully!`);
                    loadWithdrawals();
                    loadDashboardData();
                } catch (error) {
                    console.error("Error processing withdrawal:", error);
                    showAlert("âŒ Error processing withdrawal request: " + error.message, true);
                } finally {
                    loader.style.display = 'none';
                }
            });
        }

        // Utility Functions
        function showAlert(message, isError = false) {
            const alertBox = document.getElementById('custom-alert');
            const msgEl = document.getElementById('alert-message');
            if (alertBox && msgEl) {
                msgEl.textContent = message;
                alertBox.classList.remove('hidden');
            }
        }

        function showConfirm(message, onConfirm) {
            document.getElementById('confirm-message').textContent = message;
            const confirmModal = document.getElementById('custom-confirm');
            confirmModal.classList.remove('hidden');
            
            // Create new buttons to avoid duplicate listeners
            const oldOkBtn = document.getElementById('confirm-ok-btn');
            const oldCancelBtn = document.getElementById('confirm-cancel-btn');
            
            const newOkBtn = oldOkBtn.cloneNode(true);
            const newCancelBtn = oldCancelBtn.cloneNode(true);
            
            oldOkBtn.parentNode.replaceChild(newOkBtn, oldOkBtn);
            oldCancelBtn.parentNode.replaceChild(newCancelBtn, oldCancelBtn);
            
            newOkBtn.addEventListener('click', () => {
                confirmModal.classList.add('hidden');
                onConfirm();
            });
            
            newCancelBtn.addEventListener('click', () => {
                confirmModal.classList.add('hidden');
            });
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            
            if (!toast || !toastMessage) return;

            toastMessage.textContent = message;
            toast.className = `fixed top-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 z-50 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.remove('opacity-0'), 50);

            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 500);
            }, 3000);
        }

        // Make functions available globally
        window.toggleUserBlock = toggleUserBlock;
        window.processWithdrawal = processWithdrawal;
        window.openEditPointsModal = openEditPointsModal;
        window.closeEditPointsModal = closeEditPointsModal;
        window.saveUserPoints = saveUserPoints;
        window.resetDailyAds = resetDailyAds;
        window.searchUsers = searchUsers;
        window.filterWithdrawals = filterWithdrawals;
        window.testTelegramConnection = testTelegramConnection;
        window.saveTelegramConfig = saveTelegramConfig;
        window.viewUserPointHistory = viewUserPointHistory;
        window.closePointHistoryModal = closePointHistoryModal;
        window.testIpinfoApi = testIpinfoApi;
        window.resetWebsiteVisitHistory = resetWebsiteVisitHistory;
        window.addNewWebsite = addNewWebsite;
        window.removeWebsite = removeWebsite;
        window.saveWebsiteConfig = saveWebsiteConfig;
        
        // Game Management functions
        window.editGameSettings = editGameSettings;
        window.closeEditGameModal = closeEditGameModal;
        window.saveGameSettings = saveGameSettings;
        window.saveGlobalGameSettings = saveGlobalGameSettings;
        window.resetAllGameStats = resetAllGameStats;
    </script>
</body>
  </html>
