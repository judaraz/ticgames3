<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Player vs Computer</title>

  <!-- GigaPub Ads -->
  <script src="https://ad.gigapub.tech/script?id=1794"></script>
</head>
<body>
  <div class="game-container">
    <h1>Tic-Tac-Toe</h1>
    <div id="board" class="board"></div>
    <p id="status"></p>
    <p id="notification"></p>

    <button id="nextBtn">Next</button>
    <button id="rewardBtn">Reward</button>
  </div>

  <script>
    const boardElement = document.getElementById("board");
    const statusElement = document.getElementById("status");
    const notification = document.getElementById("notification");
    const nextBtn = document.getElementById("nextBtn");
    const rewardBtn = document.getElementById("rewardBtn");

    let board = Array(9).fill(null);
    let player = "X";
    let computer = "O";
    let xp = 0;
    let adWatchCount = 0;
    let timerInterval;

    // Create board
    function createBoard() {
      boardElement.innerHTML = "";
      board.forEach((value, index) => {
        const cell = document.createElement("div");
        cell.classList.add("cell");
        cell.dataset.index = index;
        cell.textContent = value || "";
        cell.addEventListener("click", handleCellClick);
        boardElement.appendChild(cell);
      });
    }

    // Player move
    function handleCellClick(e) {
      const idx = e.target.dataset.index;
      if (!board[idx] && !checkWinner(board)) {
        board[idx] = player;
        createBoard();
        if (!checkWinner(board) && board.includes(null)) {
          setTimeout(computerMove, 300);
        }
      }
    }

    // Computer move (hardest)
    function computerMove() {
      let bestScore = -Infinity;
      let move;
      board.forEach((cell, i) => {
        if (!cell) {
          board[i] = computer;
          let score = minimax(board, 0, false);
          board[i] = null;
          if (score > bestScore) {
            bestScore = score;
            move = i;
          }
        }
      });
      board[move] = computer;
      createBoard();
      checkWinner(board);
    }

    function minimax(newBoard, depth, isMaximizing) {
      let winner = evaluate(newBoard);
      if (winner !== null) return winner;

      if (isMaximizing) {
        let bestScore = -Infinity;
        newBoard.forEach((cell, i) => {
          if (!cell) {
            newBoard[i] = computer;
            let score = minimax(newBoard, depth + 1, false);
            newBoard[i] = null;
            bestScore = Math.max(score, bestScore);
          }
        });
        return bestScore;
      } else {
        let bestScore = Infinity;
        newBoard.forEach((cell, i) => {
          if (!cell) {
            newBoard[i] = player;
            let score = minimax(newBoard, depth + 1, true);
            newBoard[i] = null;
            bestScore = Math.min(score, bestScore);
          }
        });
        return bestScore;
      }
    }

    function evaluate(bd) {
      const winner = checkWinner(bd);
      if (winner === computer) return 10;
      if (winner === player) return -10;
      if (!bd.includes(null)) return 0;
      return null;
    }

    function checkWinner(bd) {
      const wins = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
      ];
      for (let [a,b,c] of wins) {
        if (bd[a] && bd[a] === bd[b] && bd[a] === bd[c]) {
          statusElement.textContent = `${bd[a]} Wins!`;
          return bd[a];
        }
      }
      if (!bd.includes(null)) {
        statusElement.textContent = "Draw!";
        return "draw";
      }
      return null;
    }

    function resetGame() {
      board = Array(9).fill(null);
      statusElement.textContent = "";
      createBoard();
    }

    // Show GigaPub ads logic
    async function showGigaAd(incrementLevel = false) {
      try {
        if (typeof window.showGiga !== "function") {
          alert("Ad not ready, please try again.");
          return;
        }

        await window.showGiga();
        adWatchCount++;

        if (incrementLevel) {
          if (adWatchCount % 9 === 0) {
            notification.innerHTML = `<p style="color:red;font-weight:bold;">Click the Ads</p>`;
            const confirmBtn = document.createElement("button");
            confirmBtn.textContent = "I Clicked the Ad";
            confirmBtn.style = "background:#ff9800;color:#fff;padding:8px 12px;border:none;border-radius:6px;cursor:pointer;";
            notification.appendChild(confirmBtn);

            confirmBtn.onclick = () => {
              let timeLeft = 30;
              notification.innerHTML = `<p>⏳ Please wait <span id="timer">${timeLeft}</span> seconds...</p>`;
              timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById("timer").textContent = timeLeft;
                if (timeLeft <= 0) {
                  clearInterval(timerInterval);
                  notification.innerHTML = `<p style="color:green;font-weight:bold;">✅ Successful</p>`;
                  setTimeout(() => {
                    xp = Math.min(xp + 1, 149);
                    notification.textContent = "";
                    resetGame();
                  }, 1500);
                }
              }, 1000);
            };
          } else {
            xp = Math.min(xp + 1, 149);
            notification.textContent = "";
            resetGame();
          }
        } else {
          resetGame();
        }

      } catch (e) {
        alert("Ad failed to load. Please try again.");
      }
    }

    // Event bindings
    nextBtn.addEventListener("click", () => showGigaAd(true));
    rewardBtn.addEventListener("click", () => showGigaAd(false));

    // Init board
    createBoard();
  </script>
</body>
</html>
