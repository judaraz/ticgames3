<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Player vs Computer</title>

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- GigaPub Ads -->
  <script src="https://ad.gigapub.tech/script?id=1794"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      background: #f3f3f3;
    }
    h1 {
      margin-bottom: 20px;
    }
    .board {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      grid-template-rows: repeat(3, 100px);
      gap: 5px;
    }
    .cell {
      width: 100px;
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      background: #fff;
      cursor: pointer;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .cell.taken {
      pointer-events: none;
    }
    #notification {
      margin-top: 15px;
      font-weight: bold;
    }
    #nextBtn {
      margin-top: 20px;
      padding: 10px 20px;
      background: #2196f3;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
    }
    #nextBtn:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>Player vs Computer</h1>
  <div class="board" id="board"></div>
  <div id="notification"></div>
  <button id="nextBtn" disabled>Next</button>

  <script>
    const boardEl = document.getElementById("board");
    const notification = document.getElementById("notification");
    const nextBtn = document.getElementById("nextBtn");

    let board, currentPlayer, gameOver;
    let xp = 0;
    let adWatchCount = 0;
    let notificationShown = false;

    function initBoard() {
      board = ["", "", "", "", "", "", "", "", ""];
      currentPlayer = "X";
      gameOver = false;
      boardEl.innerHTML = "";
      for (let i = 0; i < 9; i++) {
        const cell = document.createElement("div");
        cell.classList.add("cell");
        cell.dataset.index = i;
        cell.addEventListener("click", handleCellClick);
        boardEl.appendChild(cell);
      }
      nextBtn.disabled = true;
    }

    function handleCellClick(e) {
      if (gameOver) return;
      const idx = e.target.dataset.index;
      if (board[idx] === "") {
        board[idx] = currentPlayer;
        e.target.textContent = currentPlayer;
        e.target.classList.add("taken");
        if (checkWinner(board, currentPlayer)) {
          gameOver = true;
          notification.textContent = "üéâ You Win!";
          showNextBtn();
        } else if (board.every(c => c !== "")) {
          gameOver = true;
          notification.textContent = "üòê Draw!";
          showNextBtn();
        } else {
          currentPlayer = "O";
          setTimeout(computerMove, 500);
        }
      }
    }

    function computerMove() {
      if (gameOver) return;
      const bestMove = getBestMove(board, "O");
      board[bestMove] = "O";
      const cell = boardEl.querySelector(`[data-index='${bestMove}']`);
      cell.textContent = "O";
      cell.classList.add("taken");
      if (checkWinner(board, "O")) {
        gameOver = true;
        notification.textContent = "üíª Computer Wins!";
        showNextBtn();
      } else if (board.every(c => c !== "")) {
        gameOver = true;
        notification.textContent = "üòê Draw!";
        showNextBtn();
      } else {
        currentPlayer = "X";
      }
    }

    function checkWinner(b, p) {
      const wins = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
      ];
      return wins.some(comb => comb.every(i => b[i] === p));
    }

    function getBestMove(b, player) {
      let bestScore = -Infinity;
      let move;
      for (let i = 0; i < 9; i++) {
        if (b[i] === "") {
          b[i] = player;
          let score = minimax(b, 0, false);
          b[i] = "";
          if (score > bestScore) {
            bestScore = score;
            move = i;
          }
        }
      }
      return move;
    }

    function minimax(b, depth, isMaximizing) {
      if (checkWinner(b, "O")) return 10 - depth;
      if (checkWinner(b, "X")) return depth - 10;
      if (b.every(c => c !== "")) return 0;

      if (isMaximizing) {
        let bestScore = -Infinity;
        for (let i = 0; i < 9; i++) {
          if (b[i] === "") {
            b[i] = "O";
            let score = minimax(b, depth+1, false);
            b[i] = "";
            bestScore = Math.max(score, bestScore);
          }
        }
        return bestScore;
      } else {
        let bestScore = Infinity;
        for (let i = 0; i < 9; i++) {
          if (b[i] === "") {
            b[i] = "X";
            let score = minimax(b, depth+1, true);
            b[i] = "";
            bestScore = Math.min(score, bestScore);
          }
        }
        return bestScore;
      }
    }

    function showNextBtn() {
      nextBtn.disabled = false;
    }

    nextBtn.addEventListener("click", () => {
      showAdsAndContinue(true);
    });

    async function showAdsAndContinue(incrementLevel = false) {
      try {
        await window.showGiga(); // show GigaPub ad
        adWatchCount++;

        if (incrementLevel) {
          if (adWatchCount % 9 === 0) {
            // Special rule: must click and wait 30s
            notification.innerHTML = `<p style="color:red;font-weight:bold;">Click the Ads</p>
              <button id="confirmClick" style="background:#ff9800;color:#fff;padding:8px 12px;border:none;border-radius:6px;cursor:pointer;">
                I Clicked the Ad
              </button>`;

            document.getElementById("confirmClick").onclick = () => {
              let timeLeft = 30;
              notification.innerHTML = `<p>‚è≥ Please wait <span id="timer">${timeLeft}</span> seconds...</p>`;
              
              let timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById("timer").textContent = timeLeft;

                if (timeLeft <= 0) {
                  clearInterval(timerInterval);
                  notification.innerHTML = `<p style="color:green;font-weight:bold;">‚úÖ Successful</p>`;
                  setTimeout(() => {
                    xp = Math.min(xp + 1, 149);
                    notification.textContent = "";
                    notificationShown = false;
                    initBoard();
                  }, 1500);
                }
              }, 1000);
            };
          } else {
            // Normal ads
            xp = Math.min(xp + 1, 149);
            notification.textContent = "";
            notificationShown = false;
            initBoard();
          }
        } else {
          initBoard();
        }

      } catch (e) {
        alert("Ad failed to load. Please try again.");
      }
    }

    initBoard();
  </script>
</body>
</html>
